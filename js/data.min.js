class DataManager{constructor(){this.data=[],this.treeData={},this.nodeMap={},this.categories=[],this.sites=[]}async loadCategories(){try{return this.categories=await this.loadCsv("data/categories.csv"),this.data=this.buildDataFromCategoriesAndSites(),this.buildTree(),this.categories}catch(e){throw console.error("分类数据加载失败:",e),e}}async loadSites(){try{var e;return 0===this.sites.length&&(console.log("开始异步加载站点数据..."),e=await this.loadCsv("data/sites.csv"),this.sites=e.filter(e=>"1"===e.visible||1===e.visible),console.log("站点数据加载完成，共加载",this.sites.length,"个站点")),this.sites}catch(e){throw console.error("站点数据加载失败:",e),e}}async getSitesByCategory(t){return await this.loadSites(),this.sites.filter(e=>e.category===t)}async getAllSites(){return await this.loadSites(),this.sites}async getFullData(){return await this.loadSites(),this.data=this.buildDataFromCategoriesAndSites(),this.buildTree(),this.data}loadCsv(e){return new Promise((t,r)=>{Papa.parse(e,{download:!0,header:!0,skipEmptyLines:!0,complete:e=>{t(e.data)},error:e=>{r(e)}})})}buildDataFromCategoriesAndSites(){let t={};this.categories.forEach(e=>{t[e.id]={id:e.id,parent_id:e.parent||"",name:e.name,type:"folder",url:"",icon:"",description:"",sort_order:e.sort_order?parseInt(e.sort_order):9999}});var e=this.sites.map(e=>{let t="";if(e.icon)t=e.icon;else if(e.url)try{var r=new URL(e.url);t=r.origin+"/favicon.ico"}catch(e){}return{id:e.id,parent_id:e.category,name:e.title,type:"link",url:e.url,icon:t,description:e.description,sort_order:e.sort_order?parseInt(e.sort_order):9999}});return[...Object.values(t),...e]}buildTree(){this.nodeMap={},this.data.forEach(e=>{e.parent_id||"folder"===e.type?this.nodeMap[e.id]={...e,children:[]}:this.nodeMap[e.id]={...e}}),this.data.forEach(e=>{e.parent_id&&this.nodeMap[e.parent_id]&&this.nodeMap[e.parent_id].children.push(this.nodeMap[e.id])}),Object.values(this.nodeMap).forEach(e=>{e.children&&0<e.children.length&&e.children.sort((e,t)=>"folder"===e.type&&"link"===t.type?-1:"link"===e.type&&"folder"===t.type?1:e.sort_order-t.sort_order)}),this.treeData={id:"root",name:"所有书签",type:"folder",children:[]},this.data.forEach(e=>{e.parent_id&&""!==e.parent_id||"folder"!==e.type||this.treeData.children.push(this.nodeMap[e.id])}),this.treeData.children.sort((e,t)=>e.sort_order-t.sort_order)}getChildren(e){return e?(e=this.nodeMap[e])&&e.children||[]:this.treeData.children||[]}getNodeById(e){return"root"===e?this.treeData:this.nodeMap[e]||null}getPathToNode(r){var e=[];if("root"===r)return e.push(this.treeData),e;var i=new Set;let a=[{node:this.treeData,path:[this.treeData]}];for(;0<a.length;){let{node:e,path:t}=a.pop();if(!i.has(e.id)){if(i.add(e.id),e.id===r)return t;e.children&&0<e.children.length&&e.children.forEach(e=>{a.push({node:e,path:[...t,e]})})}}return[]}async loadPinyinPro(){return window.pinyinPro||new Promise((e,t)=>{var r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.19.6/dist/index.js",r.onload=()=>{console.log("pinyin-pro库加载完成"),e(window.pinyinPro)},r.onerror=e=>{console.error("pinyin-pro库加载失败:",e),t(e)},document.head.appendChild(r)})}async search(t){if(!t)return[];let e;try{e=await this.loadPinyinPro()}catch(e){return console.error("pinyin-pro库加载失败，使用普通搜索:",e),this.simpleSearch(t)}t=t.toLowerCase().trim();for(var r=[],i=e.pinyin(t,{toneType:"none",type:"array"}).join("").toLowerCase(),a=[...this.treeData.children];0<a.length;){var n,o=a.pop(),s=o.name&&(o.name.toLowerCase().includes(t)||e.pinyin(o.name,{toneType:"none"}).toLowerCase().includes(t)||e.pinyin(o.name,{toneType:"none",type:"array"}).join("").toLowerCase().includes(i)),d=o.description&&(o.description.toLowerCase().includes(t)||e.pinyin(o.description,{toneType:"none"}).toLowerCase().includes(t)||e.pinyin(o.description,{toneType:"none",type:"array"}).join("").toLowerCase().includes(i)),h=o.url&&(o.url.toLowerCase().includes(t)||o.url.toLowerCase().includes(i));(s||d||h)&&(n={...o},s&&(n.nameMatch=!0),d&&(n.descriptionMatch=!0),h&&(n.urlMatch=!0),r.push(n)),o.children&&0<o.children.length&&a.push(...o.children)}return r}simpleSearch(e){if(!e)return[];e=e.toLowerCase().trim();for(var t=[],r=[...this.treeData.children];0<r.length;){var i,a=r.pop(),n=a.name&&a.name.toLowerCase().includes(e),o=a.description&&a.description.toLowerCase().includes(e),s=a.url&&a.url.toLowerCase().includes(e);(n||o||s)&&(i={...a},n&&(i.nameMatch=!0),o&&(i.descriptionMatch=!0),s&&(i.urlMatch=!0),t.push(i)),a.children&&0<a.children.length&&r.push(...a.children)}return t}highlightKeyword(e,t){var r,i;return e&&t&&(i=e.toLowerCase(),r=t.toLowerCase(),i.includes(r))?(i=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"),e.replace(i,"<mark>$1</mark>")):e}}let dataManager=new DataManager;