let navigationHistory=[],currentNodeId="root";async function renderContent(e){currentNodeId=e,navigationHistory[navigationHistory.length-1]!==e&&(navigationHistory.push(e),50<navigationHistory.length)&&navigationHistory.shift(),updateBackButton();let n=document.getElementById("itemsContainer");var t=document.getElementById("breadcrumb"),a=(n.innerHTML="",t.querySelector(".back-button")),t=(t.innerHTML="",a&&t.appendChild(a),dataManager.getNodeById(e));if(t){if(renderBreadcrumb(e),"root"!==e&&"folder"===t.type)try{await dataManager.getFullData(),console.log("已按需加载站点数据")}catch(e){return console.error("站点数据加载失败:",e),void(n.innerHTML="<p>站点数据加载失败，请稍后重试。</p>")}a=dataManager.getChildren(e);a&&0!==a.length&&(a.forEach((e,t)=>{e=createItemRow(e,t);n.appendChild(e)}),updateDarkModeClasses())}else n.innerHTML="<p>未找到该分类或站点。</p>"}function createItemRow(e,t){var n=document.createElement("div");n.className="item-row "+e.type,n.style.animationDelay=.05*t+"s";let a=document.createElement("div");if(a.className="item-icon",e.icon){t=document.createElement("img");t.src=e.icon,t.alt=e.name,t.className="item-favicon",t.onerror=function(){a.textContent="folder"===e.type?"📁":"🔗"},a.appendChild(t)}else if("folder"===e.type)a.textContent="📁";else if(e.url)try{var o=new URL(e.url).origin+"/favicon.ico",r=document.createElement("img");r.src=o,r.alt=e.name,r.className="item-favicon",r.onerror=function(){a.textContent="🔗"},a.appendChild(r)}catch(e){a.textContent="🔗"}else a.textContent="🔗";var t=document.createElement("div"),o=(t.className="item-info",document.createElement("div")),r=(o.className="item-title-container",document.createElement("span"));return r.className="item-title",r.textContent=e.name,o.appendChild(r),e.description&&((r=document.createElement("span")).className="item-description",r.textContent=e.description,o.appendChild(r)),t.appendChild(o),e.url&&((r=document.createElement("div")).className="item-url",r.textContent=e.url,t.appendChild(r)),n.appendChild(a),n.appendChild(t),n.addEventListener("click",async()=>{"folder"===e.type?(treeRenderer.selectNode(e.id),await renderContent(e.id)):"link"===e.type&&window.open(e.url,"_blank")}),n}function renderBreadcrumb(e){let a=document.getElementById("breadcrumb"),o=dataManager.getPathToNode(e);o.forEach((e,t)=>{0<t&&((n=document.createElement("span")).className="breadcrumb-separator",n.textContent=">",a.appendChild(n));var n=document.createElement("span");n.className="breadcrumb-item",n.textContent=e.name,n.dataset.id=e.id,t===o.length-1?n.style.fontWeight="bold":n.addEventListener("click",async()=>{treeRenderer.selectNode(e.id),await renderContent(e.id)}),a.appendChild(n)}),updateDarkModeClasses()}async function handleSearch(){let a=document.getElementById("searchInput").value.trim();if(a){let n=document.getElementById("itemsContainer");n.innerHTML=`<h2>搜索中: "${a}"</h2><p>正在加载搜索功能...</p>`;try{var e=await dataManager.search(a);document.getElementById("backButton");n.innerHTML=`<h2>搜索结果: "${a}"</h2>`,0===e.length?(n.innerHTML+="<p>未找到匹配的结果，请尝试其他关键词。</p>",updateDarkModeClasses()):(e.forEach((e,t)=>{e=createSearchResultRow(e,a,t);n.appendChild(e)}),updateDarkModeClasses())}catch(e){console.error("搜索失败:",e),n.innerHTML="<h2>搜索失败</h2><p>搜索功能暂时不可用，请稍后重试。</p>"}}}function createSearchResultRow(e,t,n){var a=document.createElement("div");a.className="item-row "+e.type,a.style.animationDelay=.05*n+"s";let o=document.createElement("div");o.className="item-icon",e.icon?((n=document.createElement("img")).src=e.icon,n.alt=e.name,n.className="item-favicon",n.onerror=function(){o.textContent="folder"===e.type?"📁":"🔗"},o.appendChild(n)):"folder"===e.type?o.textContent="📁":o.textContent="🔗";var n=document.createElement("div"),r=(n.className="item-info",document.createElement("div")),d=(r.className="item-title-container",document.createElement("span"));return d.className="item-title",d.innerHTML=dataManager.highlightKeyword(e.name,t),r.appendChild(d),e.description&&((d=document.createElement("span")).className="item-description",d.innerHTML=dataManager.highlightKeyword(e.description,t),r.appendChild(d)),n.appendChild(r),e.url&&((d=document.createElement("div")).className="item-url",d.innerHTML=dataManager.highlightKeyword(e.url,t),n.appendChild(d)),a.appendChild(o),a.appendChild(n),a.addEventListener("click",async()=>{"folder"===e.type?(treeRenderer.selectNode(e.id),await renderContent(e.id)):"link"===e.type&&window.open(e.url,"_blank")}),a}function createSampleData(){console.log("请在项目根目录下创建data文件夹，并在其中创建sites.csv和categories.csv文件，内容如下:"),console.log("categories.csv:"),console.log("id,name,parent,sort_order"),console.log("tech,科技,,1"),console.log("dev,开发,,2"),console.log(""),console.log("sites.csv:"),console.log(`id,title,url,description,category,icon,visible,sort_order
Google,https://www.google.com/favicon.ico,https://www.google.com/,全球最大的搜索引擎,tech,,1,1
GitHub,https://github.com/favicon.ico,https://github.com/,全球最大的代码托管平台,dev,,1,1
MDN,https://developer.mozilla.org/favicon-48x48.cbbd161b.png,https://developer.mozilla.org/,Web开发文档资源,frontend,,1,1
React,https://reactjs.org/favicon.ico,https://reactjs.org/,用于构建用户界面的JavaScript库,framework,,1,1
Vue,https://vuejs.org/images/logo.png,https://vuejs.org/,渐进式JavaScript框架,framework,,1,2
Angular,https://angular.io/assets/images/favicons/favicon.ico,https://angular.io/,现代Web开发平台,framework,,1,3
`),alert("请创建 data/categories.csv 和 data/sites.csv 文件，内容可参考控制台输出")}function toggleTheme(){document.body.classList.toggle("dark-mode"),updateThemeIcons(),document.body.classList.contains("dark-mode")?localStorage.setItem("hamster-bookmarks-theme","dark"):localStorage.setItem("hamster-bookmarks-theme","light"),updateDarkModeClasses();let e=document.getElementById("themeToggle");e.classList.add("theme-toggle-clicked"),setTimeout(()=>{e.classList.remove("theme-toggle-clicked")},300)}function handleSystemThemeChange(e){localStorage.getItem("hamster-bookmarks-theme")||(e.matches?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"),updateThemeIcons(),updateDarkModeClasses())}function updateThemeIcons(){let e=document.getElementById("themeToggle");document.body.classList.contains("dark-mode")?e.textContent="☀️":e.textContent="🌙",e.style.transform="scale(1.2)",setTimeout(()=>{e.style.transform="scale(1)"},300)}function updateDarkModeClasses(){document.querySelectorAll(".sidebar, .items-container, .breadcrumb, .search-box input, .search-box button, .tree-item:hover, .tree-item.selected, .breadcrumb-item:hover, .item-row, .item-description, .item-url, .breadcrumb-separator, .back-button, .content-header, mark, .website-logo").forEach(e=>{document.body.classList.contains("dark-mode")?e.classList.add("dark-mode"):e.classList.remove("dark-mode")})}async function goBack(){var e;navigationHistory.length<=1||(navigationHistory.pop(),e=navigationHistory[navigationHistory.length-1],treeRenderer.selectNode(e),await renderContent(e))}function updateBackButton(){document.getElementById("backButton").disabled=navigationHistory.length<=1}async function goToHome(){document.getElementById("searchInput").value="",treeRenderer.selectNode("root"),await renderContent("root")}document.addEventListener("DOMContentLoaded",async function(){window.treeRenderer=new TreeRenderer("folderTree",dataManager);try{await dataManager.loadCategories(),console.log("基础分类数据加载完成"),treeRenderer.renderTree(),await renderContent("root"),navigationHistory=["root"],updateBackButton()}catch(e){console.error("基础数据加载失败:",e),alert("基础数据加载失败，请检查 data/categories.csv 格式及内容！"),createSampleData()}document.getElementById("searchBtn").addEventListener("click",handleSearch),document.getElementById("searchInput").addEventListener("keypress",async function(e){"Enter"===e.key&&await handleSearch()}),document.addEventListener("nodeSelected",async function(e){await renderContent(e.detail.nodeId)}),document.getElementById("themeToggle").addEventListener("click",toggleTheme),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",handleSystemThemeChange),document.getElementById("backButton").addEventListener("click",goBack),document.getElementById("logoContainer").addEventListener("click",function(e){e.target!==this&&!e.target.classList.contains("website-logo")&&"siteTitle"!==e.target.id||goToHome()}),document.getElementById("siteTitle").addEventListener("click",goToHome);var e=localStorage.getItem("hamster-bookmarks-theme");"dark"===e||"light"!==e&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"),updateThemeIcons()});